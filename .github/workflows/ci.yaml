name: CI

on:
  push:
    branches: [ main, actions, bazel ]
  pull_request:
    branches: [ main, actions, bazel ]

env:
  TEST_STATS_DELAY: 5000

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      rabbitmq:
        image: pivotalrabbitmq/rabbitmq:main-otp-max-bazel
        ports:
        - 15672:15672
    steps:
    - name: CHECKOUT
      uses: actions/checkout@v3
    - name: MOUNT BAZEL CACHE
      uses: actions/cache@v3.3.1
      with:
        path: "/home/runner/repo-cache/"
        key: ${{ runner.os }}-repo-cache-${{ hashFiles('Cargo.lock','WORKSPACE.bazel') }}
        restore-keys: |
          ${{ runner.os }}-repo-cache-
    - name: CONFIGURE BAZEL
      run: |
        cat << EOF >> user.bazelrc
          build:buildbuddy --repository_cache=/home/runner/repo-cache/
          build:buildbuddy --color=yes
          build:buildbuddy --disk_cache=
        EOF
    # - name: Setup tmate session
    #   uses: mxschmitt/action-tmate@v3
    - name: CONFIGURE RABBITMQ
      run: |
        c="$(docker ps --format '{{.ID}}')"

        RUST_HTTP_API_CLIENT_RABBITMQCTL="docker exec $c rabbitmqctl" \
        RUST_HTTP_API_CLIENT_RABBITMQ_PLUGINS="docker exec $c rabbitmq-plugins" \
        ./bin/ci/before_build.sh
    - name: TEST
      run: |
        bazel test //... \
          --config=buildbuddy \
          --test_env RUST_BACKTRACE=1
